= Protect a Fabric8 REST Service with Apiman
:hp-tags: Api Management, Fabric8, Policies, REST
:numbered:

*Apiman* is a API Management application that help you add policies to your service and set up and enforce contracts between service producers and consumers. 
*Fabric8* is cloud infrastructure build on Kubernetes and Docker. Please follow https://kurtstam.github.io/2015/09/22/Bleeding-edge-steps-to-Deploy-Apiman-to-Fabric8.html[these steps] to get Apiman running on Fabric8. In this post I will show you how to deploy a REST quickstart to Fabric8 and how to publish it as a Public Service on the Apiman Gateway protected by Simple Authentication.

== Deploy a REST based service to Fabric8
When Fabric8 is running follow these steps to deploy the CXFCDI quickstart
....
git clone https://github.com/fabric8io/ipaas-quickstarts
cd ipaas-quickstarts/quickstarts
mvn install
cd java/cxf-cdi/
mvn clean install fabric8:json docker:build  fabric8:apply
....
When the build succeeds the CXFCDI service appears in the http://fabric8.vagrant.f8 console as shown below

image::Fabric8CxfCdi.png[]
[caption="Figure 1: "]
.CxfCdi quickstart running on Fabric8.

and you can access the endpoint in your browser at http://quickstart-java-cxf-cdi.vagrant.f8/quickstart-java-cxf-cdi/cxfcdi/, and http://quickstart-java-cxf-cdi.vagrant.f8/quickstart-java-cxf-cdi/cxfcdi/swagger.json for the swagger definition.

image::CxfCdi.png[]
[caption="Figure 2: "]
.CxfCdi service listing.

== Publish and Protect the CxfCdi with a Simple Authentication Policy on the Apiman Gateway
In the real world you would not expose the cxfcdi endpoint shown above. Instead you would only expose the Apiman Gateway on your firewall, and you would only publish the services you'd want to expose publicly. So let's go ahead and publish the CxfCdi service as a _Public Service_. A *Public Service* is a service that consumers can use without having a _Contract_ in place. In this case all the'd need to have is a valid username/password combo. 

=== Add your Organization
If you don't have an Organization already create one now by navigating to the API Management tab and clicking _Create a new Organization_. Create your Organization.

=== Import Services
Within your Organization select _Services_ and then click on the little dropdown next to the _New Service_ button. Click on the _Import Service_ popup to enter the _Import Services_ wizzard. This wizzards allows you to bulk import services. In the _Find Services_ 'quickstart' to find the quickstarts in the current namespace (or '*' for all services in the namespace). Then select to add the _CxfCdi Quickstart_, and when select the 'Public Service' check box (For this it's ok that we don't have any plans setup). Then click _Finish_ and your new Service should show up under the list of Services for your Organization. Go ahead and click on the CxfCdi Service.

=== Swagger apidocs
The CxfCdi service publishes a swagger.json service definition file that was imported by Apiman. 

=== Publish CxfCxf Service to the Gateway
At this point we really need to do is to _Publish_ the service. So let's click on the Publish button. On the leftnav will now appear an 'Endpoint' entry. YOu can select this to see the URL under which the Gateway has now published the service. This should something like http://quickstart-java-cxfcdi.vagrant.f8/gateway/KurtOrg/v1.0/

=== Add Simple Auth Policy



